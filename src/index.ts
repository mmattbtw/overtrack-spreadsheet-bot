import axios from "axios";
import {
  GoogleSpreadsheet,
  GoogleSpreadsheetWorksheet,
} from "google-spreadsheet";
import config from "./config";
import constants from "./constants";
import { overbuffData } from "./typings";

const doc = new GoogleSpreadsheet(config.googleSheetID);

(async function () {
  // Initialize Auth - see https://theoephraim.github.io/node-google-spreadsheet/#/getting-started/authentication
  await doc.useServiceAccountAuth({
    // env var values are copied from service account credentials generated by google
    // see "Authentication" section in docs for more info
    client_email: config.googleAccountEmail,
    private_key: config.googlePrivateKey,
  });

  await doc.loadInfo();

  let sheet: GoogleSpreadsheetWorksheet;
  // ty is cool but balls are cooler

  if (doc.sheetCount < 1) {
    // If there are no sheets present:
    sheet = await doc.addSheet({
      // Make a new sheet with the Tank, DPS, and Support header values.
      headerValues: ["TANK", "DPS", "SUPPORT"],
    });
  } else if (doc.sheetCount == 1) {
    // If there is already a sheet:
    const sheets = doc.sheetsByIndex; // Grab the current sheet
    sheet = sheets[0]; // Put it in `sheet` variable.
  }

  // MAIN FUNCION \\
  /* This runs every 3 minutes
    It polls the Overtrack API, checks if the last game's ID and the local ID are the same
    If they aren't, adds the gained (or lost) SR to the spreadsheet */
  setInterval(async () => {
    console.log("Pinging Overtrack API...");
    let resp: overbuffData = await axios.get(constants.overbuffUrl);

    console.log(resp.data.games[0]);
    console.log("Data recieved.");
  }, 1000); // Function is called every 3 minutes
})();
